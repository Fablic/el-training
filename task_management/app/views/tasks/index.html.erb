<%= javascript_pack_tag 'tasks/index', 'data-turbolinks-track': 'reload' %>
<div class="container_tasks">
  <% content_for(:title, I18n.t('tasks.index.title')) %>
  <h1><%= I18n.t('tasks.index.title') %></h1>
  ログインユーザ名：<%= @login_user.name %>
  <hr>
  <%= form_with url: tasks_path, method: :get, local: true do |f| %>
    <%= I18n.t('tasks.header.status') %>
    <%= f.radio_button :status, :all, id: 'all', checked: true %><%= f.label 'all', I18n.t('tasks.index.status.all') %>
    <%= f.radio_button :status, :todo, id: 'todo' %><%= f.label 'todo', I18n.t('tasks.index.status.todo') %>
    <%= f.radio_button :status, :in_progress, id: 'in_progress'  %><%= f.label 'in_progress', I18n.t('tasks.index.status.in_progress') %>
    <%= f.radio_button :status, :done, id: 'done' %><%= f.label 'done', I18n.t('tasks.index.status.done') %>
    <div class="labels">
      <%= I18n.t('tasks.header.label') %>
      <%= check_box_tag 'all-select', 'all-select', true %>
      <%= label_tag 'all-select', '全選択' %>
      <div id="boxes">
        <% @labels.each do |label| %>
          <div class="task-label test-color">
            <% label_ids = "label_ids[#{label.id}]" %>
            <%= check_box_tag label_ids, "#{label.id}", false, :name => "label_ids[]" %>
            <%= label_tag label_ids, label.name %>
          </div>
        <% end %>
      </div>
    </div>
    <%= f.text_field :search_word, placeholder: I18n.t('tasks.input.task'), id: 'search_word', value: @search_params[:search_word] %>
    <%= f.submit I18n.t('tasks.button.type.search'), name: 'search_btn' %>
  <% end %>

  <hr>
  <div id="tasks_list">
    <table>
      <!-- テーブルヘッダ -->
      <thead>
        <tr>
          <th class="no">No</th>
          <th class="name"><%= I18n.t('tasks.header.name') %></th>
          <!-- TODO:昇順ソートも出来るようにする -->
          <th class="deadline"><%= I18n.t('tasks.header.deadline') %>
            <%= link_to image_tag('tasks/desc_icon.png', class: 'icon sort_icon'),
                        {controller: "tasks", action: "index",
                         sort: "deadline"},
                        id: "deadline_desc" %>
          </th>
          <th class="priority"><%= I18n.t('tasks.header.priority') %></th>
          <th class="status"><%= I18n.t('tasks.header.status') %></th>
          <th class="creation_date"><%= I18n.t('tasks.header.creation_date') %></th>
          <th class="edit"><%= I18n.t('tasks.header.edit') %></th>
          <th class="delete"><%= I18n.t('tasks.header.delete') %></th>
        </tr>
      </thead>

      <!-- テーブルボディ -->
      <tbody>
        <% i = 0 %>
        <% @tasks.each do |task| %>
          <tr>
            <td class="no"><%= i += 1 %></td>
            <td class="name">
              <div class="labels">
                <% task.labels.each do |label| %>
                  <div class="task-label test-color">
                    <% label_ids = "label_ids[][#{label.id}]" %>
                    <%= label_tag label_ids, label.name %>
                  </div>
                <% end %>
              </div>
              <%= link_to task.name, task_path(task), class: 'link link-show' %>
            </td>
            <td class="deadline"><%= show_date_s(task.deadline) %></td>
            <td class="priority"><%= task.priority_i18n %></td>
            <td class="status"><%= task.status_i18n %></td>
            <td class="creation_date"><%= show_date_time_s(task.creation_date) %></td>
            <td class="edit"><%= link_to image_tag('tasks/edit_icon.png', class: 'icon edit_icon'),
                                         edit_task_path(task),
                                         { id: "edit_link_#{i}" } %>
            </td>
            <td class="delete"><%= link_to image_tag('tasks/delete_icon.png', class: 'icon delete_icon'),
                                           task_path(task),
                                           { method: :delete,
                                             data: { confirm: I18n.t('tasks.index.confirm_delete') },
                                             id: "delete_link_#{i}"
                                           } %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <br>
    <%= paginate @tasks %>
  </div>
  <hr>
  <%= link_to I18n.t('tasks.footer.new'), new_task_path %>
  <hr>
  <%= button_to I18n.t('layouts.common.logout'), logout_path(@login_user),
                { method: :delete,
                  data: { confirm: I18n.t('layouts.common.confirm_logout'),
                          disable_with: I18n.t('layouts.common.load_logout') }
                } %>
</div>

<input name="label_ids_json" type="hidden" value=<%= @label_ids_json %> class='label_ids_json'/>
<input name="status_btn_val" type="hidden" value=<%= @status %> id='status_btn_val'/>
<%= javascript_tag do %>
  setStatus();
  setLabel();

  function setStatus() {
    $('input[name=status]').val([$('#status_btn_val').val()]);
  }

  function setLabel() {
    let labelIdsJson = $('.label_ids_json').val();
    let label = JSON.parse(labelIdsJson);
    let label_ids_elm = $("input[name='label_ids[]']");

    label_ids_elm.each(function(i, elem) {
        $(elem).prop('checked', false);
    });
    for (let key in label) {
      label_ids_elm.each(function(i, elem) {
      if (elem.defaultValue === label[key]) {
        $(elem).prop('checked', true);
      }
      });
    }
    if ($('#boxes :checked').length === $('#boxes :input').length) {
      $('#all-select').prop('checked', true);
    } else {
      $('#all-select').prop('checked', false);
    }
  }
<% end %>
